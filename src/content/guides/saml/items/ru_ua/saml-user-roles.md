FastComments сопоставляет роли пользователей SAML с внутренними разрешениями, обеспечивая управление доступом на основе ролей для вашей организации.

### Система ролей FastComments

FastComments использует систему разрешений на основе ролей, где у пользователей может быть одна или несколько ролей, определяющих их уровни доступа и возможности.

### Доступные роли FastComments

#### Административные роли

**fc-account-owner**
- **Permissions**: Полный административный доступ
- **Capabilities**: Все функции, управление выставлением счетов, управление пользователями
- **Use Case**: Основные администраторы аккаунта и владельцы

**fc-admin-admin**  
- **Permissions**: Административный доступ ко большинству функций
- **Capabilities**: Управление пользователями, конфигурация, модерация. **Может управлять другими администраторами.**
- **Use Case**: Вторичные администраторы и IT-персонал

**fc-billing-admin**
- **Permissions**: Управление выставлением счетов и подписками
- **Capabilities**: Платежные методы, счета, изменения подписки
- **Use Case**: Сотрудники финансового отдела и контактные лица по биллингу

#### Специализированные роли

**fc-analytics-admin**
- **Permissions**: Доступ к аналитике и отчетности
- **Capabilities**: Просмотр статистики сайта, данных вовлеченности пользователей
- **Use Case**: Маркетинговые команды и аналитики данных

**fc-api-admin**
- **Permissions**: Доступ к API и его управление
- **Capabilities**: Учетные данные API, конфигурация webhook
- **Use Case**: Разработчики и технические интеграторы

**fc-moderator**
- **Permissions**: Возможности модерации комментариев
- **Capabilities**: Одобрение/отклонение комментариев, управление спамом
- **Use Case**: Модераторы сообщества и менеджеры контента

### Конфигурация сопоставления ролей

#### Источники атрибутов SAML

FastComments принимает информацию о ролях из различных имен атрибутов SAML для обеспечения совместимости с разными провайдерами идентичности:

**Standard Attribute Names**:
- `roles`
- `groups` 
- `memberOf`
- `role`
- `group`

**Microsoft/ADFS Attributes**:
- `http://schemas.microsoft.com/ws/2008/06/identity/claims/role`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role`

#### Поддерживаемые форматы ролей

**Array Format** *(Preferred)*:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin</saml:AttributeValue>
    <saml:AttributeValue>fc-moderator</saml:AttributeValue>
</saml:Attribute>
```

**Comma-Separated Format**:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin,fc-moderator</saml:AttributeValue>
</saml:Attribute>
```

**Single Role Format**:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin</saml:AttributeValue>
</saml:Attribute>
```

### Конфигурация ролей поставщика идентификации

#### Microsoft Azure AD

1. **App Roles Configuration**:
   - Определите роли FastComments в вашем приложении Azure AD
   - Назначьте пользователям соответствующие роли приложения
   - Настройте claims для включения назначенных ролей

2. **Attribute Mapping**:
   ```
   Attribute Name: roles
   Source Attribute: user.assignedroles
   ```

#### Okta

1. **Group Assignment**:
   - Создайте группы, соответствующие именам ролей FastComments
   - Назначьте пользователей в соответствующие группы
   - Настройте statements атрибутов

2. **Attribute Statement**:
   ```
   Name: roles
   Value: user.groups
   Filter: Starts with "fc-"
   ```

#### Google Workspace

1. **Group Mapping**:
   - Создайте организационные подразделения или группы
   - Назовите группы с префиксами ролей FastComments
   - Настройте сопоставление атрибутов

2. **Custom Attributes**:
   ```
   Attribute Name: roles
   Value: Groups or custom schema attribute
   ```

### Поведение пользователя по умолчанию

#### Пользователи без ролей

Когда у SAML-пользователя нет ролей или роли не распознаны:
- Пользователь создается как обычный комментатор
- Административный доступ не предоставляется
- Может публиковать и управлять своими комментариями
- Не может получить доступ к функциям панели администратора

#### Наследование ролей

- У пользователей может быть несколько ролей одновременно
- Разрешения суммируются (применяется наивысший уровень разрешений)
- Изменения ролей в IdP отражаются при следующем входе

### Управление пользователями SAML

#### Создание пользователя

Когда пользователь входит через SAML впервые:
1. **Учетная запись пользователя**: Автоматически создается с электронной почтой в качестве идентификатора
2. **Назначение ролей**: Роли применяются на основе атрибутов SAML
3. **Информация профиля**: Имя/фамилия заполняются, если предоставлены
4. **Активация разрешений**: Роли становятся активными немедленно

#### Обновления ролей

Существующие SAML-пользователи получают обновления ролей:
1. **Триггер входа**: Обновления ролей происходят при каждом SAML-входе
2. **Немедленный эффект**: Новые разрешения применяются сразу
3. **Удаление роли**: Удаленные роли автоматически отзываются
4. **Аудиторский след**: Изменения ролей записываются в аудит

### Пользовательское сопоставление ролей

#### Корпоративная настройка

Для корпоративных клиентов с особыми требованиями:
- Пользовательские имена ролей могут быть сопоставлены с разрешениями FastComments
- Можно реализовать сложные иерархии ролей
- Можно настроить контроль доступа по отделам

Свяжитесь со службой поддержки FastComments для конфигурации пользовательского сопоставления ролей.

#### Проверка ролей

FastComments проверяет входящие роли:
- Нераспознанные роли игнорируются (не отклоняются)
- Неправильные атрибуты ролей логируются для устранения неполадок
- Пользователи сохраняют существующие роли, если в SAML-утверждении отсутствует информация о ролях

### Лучшие практики

#### Управление ролями

1. **Принцип наименьших привилегий**: Назначайте минимально необходимые разрешения
2. **Регулярный аудит**: Периодически пересматривайте роли пользователей и доступ  
3. **Понятные имена**: Используйте описательные имена групп в вашем IdP
4. **Документация**: Ведите документацию назначения ролей

#### Соображения по безопасности

1. **Атрибуты ролей**: Убедитесь, что атрибуты ролей надежно защищены в ответах SAML
2. **Проверка атрибутов**: Убедитесь, что только авторизованные системы могут назначать роли
3. **Проверки доступа**: Регулярно проверяйте назначения административных ролей
4. **Мониторинг**: Отслеживайте изменения ролей и административные действия

### Устранение неполадок с ролями

#### Распространенные проблемы

**Roles Not Applied**:
- Проверьте, что имена атрибутов SAML соответствуют поддерживаемым форматам
- Убедитесь, что IdP отправляет информацию о ролях
- Подтвердите, что значения ролей точно соответствуют именам ролей FastComments

**Access Denied**:
- Убедитесь, что пользователю назначена соответствующая роль в IdP
- Проверьте орфографию ролей и чувствительность к регистру
- Подтвердите правильность формата ролей в ответе SAML

**Missing Permissions**:
- Просмотрите определения ролей и требуемые разрешения
- Проверьте наличие конфликтующих назначений ролей
- Убедитесь, что пользователь входил в систему после изменений ролей

---