FastComments сопоставляет роли пользователей SAML с внутренними разрешениями, обеспечивая управление доступом на основе ролей для вашей организации.

### Система ролей FastComments

FastComments использует систему разрешений на основе ролей, где пользователи могут иметь одну или несколько ролей, определяющих их уровни доступа и возможности.

### Доступные роли FastComments

#### Роли администрирования

**fc-account-owner**
- **Разрешения**: Полный административный доступ
- **Возможности**: Все функции, управление платежами, управление пользователями
- **Сценарий использования**: Основные администраторы аккаунта и владельцы

**fc-admin-admin**  
- **Разрешения**: Административный доступ к большинству функций
- **Возможности**: Управление пользователями, конфигурация, модерация. **Может администрировать других администраторов.**
- **Сценарий использования**: Вторичные администраторы и IT-персонал

**fc-billing-admin**
- **Разрешения**: Управление выставлением счетов и подписками
- **Возможности**: Платежные методы, счета, изменения подписки
- **Сценарий использования**: Сотрудники финансового отдела и контактные лица по выставлению счетов

#### Специализированные роли

**fc-analytics-admin**
- **Разрешения**: Доступ к аналитике и отчетности
- **Возможности**: Просмотр статистики сайта, данных вовлеченности пользователей
- **Сценарий использования**: Маркетинговые команды и аналитики данных

**fc-api-admin**
- **Разрешения**: Доступ к API и управление им
- **Возможности**: Учетные данные API, настройка вебхуков
- **Сценарий использования**: Разработчики и технические интеграторы

**fc-moderator**
- **Разрешения**: Возможности модерации комментариев
- **Возможности**: Одобрение/отклонение комментариев, управление спамом
- **Сценарий использования**: Модераторы сообществ и менеджеры контента

### Конфигурация сопоставления ролей

#### Источники атрибутов SAML

FastComments принимает информацию о ролях из различных имен атрибутов SAML для обеспечения совместимости с разными поставщиками удостоверений:

**Стандартные имена атрибутов**:
- `roles`
- `groups` 
- `memberOf`
- `role`
- `group`

**Атрибуты Microsoft/ADFS**:
- `http://schemas.microsoft.com/ws/2008/06/identity/claims/role`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/role`

#### Поддерживаемые форматы ролей

**Формат массива** *(Предпочтительный)*:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin</saml:AttributeValue>
    <saml:AttributeValue>fc-moderator</saml:AttributeValue>
</saml:Attribute>
```

**Формат через запятую**:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin,fc-moderator</saml:AttributeValue>
</saml:Attribute>
```

**Формат одиночной роли**:
```xml
<saml:Attribute Name="roles">
    <saml:AttributeValue>fc-admin-admin</saml:AttributeValue>
</saml:Attribute>
```

### Конфигурация ролей провайдера удостоверений

#### Microsoft Azure AD

1. **Конфигурация ролей приложения**:
   - Определите роли FastComments в вашем приложении Azure AD
   - Назначьте пользователям соответствующие роли приложения
   - Настройте claims для включения назначенных ролей

2. **Сопоставление атрибутов**:
   ```
   Attribute Name: roles
   Source Attribute: user.assignedroles
   ```

#### Okta

1. **Назначение групп**:
   - Создайте группы, соответствующие именам ролей FastComments
   - Назначьте пользователей в соответствующие группы
   - Настройте утверждения атрибутов

2. **Утверждение атрибутов**:
   ```
   Name: roles
   Value: user.groups
   Filter: Starts with "fc-"
   ```

#### Google Workspace

1. **Сопоставление групп**:
   - Создайте организационные единицы или группы
   - Назовите группы с префиксами ролей FastComments
   - Настройте сопоставление атрибутов

2. **Пользовательские атрибуты**:
   ```
   Attribute Name: roles
   Value: Groups or custom schema attribute
   ```

### Поведение пользователя по умолчанию

#### Пользователи без ролей

Когда у пользователя SAML нет ролей или роли не распознаны:
- Пользователь создается как обычный комментатор
- Административный доступ не предоставляется
- Может публиковать и управлять собственными комментариями
- Не может получить доступ к функциям панели администратора

#### Наследование ролей

- Пользователи могут иметь несколько ролей одновременно
- Разрешения суммируются (применяется наивысший уровень разрешений)
- Изменения ролей в IdP отражаются при следующем входе

### Управление пользователями SAML

#### Создание пользователя

Когда пользователь входит через SAML впервые:
1. **Учетная запись пользователя**: Автоматически создается с email в качестве идентификатора
2. **Назначение ролей**: Роли применяются на основе атрибутов SAML
3. **Информация профиля**: Имя/фамилия заполняются, если предоставлены
4. **Активация разрешений**: Роли становятся активными немедленно

#### Обновления ролей

Существующие пользователи SAML получают обновления ролей:
1. **Триггер входа**: Обновления ролей происходят при каждом входе через SAML
2. **Немедленный эффект**: Новые разрешения применяются сразу
3. **Удаление ролей**: Удаленные роли автоматически отзываются
4. **Аудит**: Изменения ролей записываются в журналы аудита

### Пользовательское сопоставление ролей

#### Корпоративная настройка

Для корпоративных клиентов с особыми требованиями:
- Пользовательские имена ролей могут быть сопоставлены с разрешениями FastComments
- Можно реализовать сложные иерархии ролей
- Можно настроить правила доступа для конкретных департаментов

Свяжитесь со службой поддержки FastComments для настройки пользовательского сопоставления ролей.

#### Проверка ролей

FastComments проверяет входящие роли:
- Нераспознанные роли игнорируются (не отклоняются)
- Неправильно сформированные атрибуты ролей логируются для устранения неполадок
- Пользователи сохраняют существующие роли, если в SAML-утверждении отсутствует информация о ролях

### Лучшие практики

#### Управление ролями

1. **Принцип наименьших привилегий**: Назначайте минимально необходимые разрешения
2. **Регулярный аудит**: Периодически проверяйте роли и доступы пользователей  
3. **Понятные наименования**: Используйте описательные имена групп в вашем IdP
4. **Документация**: Поддерживайте документацию по назначению ролей

#### Соображения безопасности

1. **Атрибуты ролей**: Убедитесь, что атрибуты ролей надежно защищены в ответах SAML
2. **Проверка атрибутов**: Убедитесь, что только авторизованные системы могут назначать роли
3. **Проверки доступа**: Регулярно проверяйте назначения административных ролей
4. **Мониторинг**: Отслеживайте изменения ролей и административные действия

### Устранение неполадок с ролями

#### Распространенные проблемы

**Роли не применяются**:
- Проверьте, соответствуют ли имена атрибутов SAML поддерживаемым форматам
- Убедитесь, что IdP отправляет информацию о ролях
- Подтвердите, что значения ролей точно соответствуют именам ролей FastComments

**Доступ запрещен**:
- Убедитесь, что пользователю назначена соответствующая роль в IdP
- Проверьте правописание ролей и чувствительность к регистру
- Убедитесь, что роль правильно отформатирована в ответе SAML

**Отсутствуют разрешения**:
- Проверьте определения ролей и требуемые разрешения
- Проверьте наличие конфликтующих назначений ролей
- Убедитесь, что пользователь вошел после изменений ролей

---