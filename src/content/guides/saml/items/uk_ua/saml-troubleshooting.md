Цей посібник охоплює поширені проблеми аутентифікації SAML та їх вирішення.

### Проблеми з сертифікатом та безпекою

#### Помилка недійсного сертифіката

**Симптоми**:
- Помилка "Certificate validation failed"
- Користувачі не можуть завершити аутентифікацію SAML
- SAML-відповіді відхиляються

**Типові причини**:
- Формат сертифіката неправильний
- Сертифікат прострочений
- Надався неправильний сертифікат
- Додаткові символи або пробіли в сертифікаті

**Рішення**:
1. **Перевірте формат сертифіката**:
   - Переконайтеся, що сертифікат містить маркери `-----BEGIN CERTIFICATE-----` та `-----END CERTIFICATE-----`
   - Видаліть зайві пробіли або розриви рядків
   - Скопіюйте сертифікат безпосередньо з метаданих або конфігурації IdP

2. **Перевірте дійсність сертифіката**:
   - Переконайтеся, що сертифікат не прострочений
   - Підтвердіть, що сертифікат призначений для правильного IdP
   - Використовуйте онлайн-валідатори сертифікатів для перевірки формату

3. **Завантажте сертифікат заново**:
   - Завантажте новий сертифікат з IdP
   - Використовуйте URL метаданих IdP, якщо він доступний
   - Підтвердіть, що сертифікат відповідає поточній конфігурації IdP

#### Помилка перевірки підпису

**Симптоми**:
- Помилки перевірки підпису SAML-утвердження
- Аутентифікація не вдається після входу в IdP
- Повідомлення про помилку "Invalid signature"

**Рішення**:
1. **Невідповідність алгоритму**:
   - Перевірте, що алгоритм підпису в FastComments відповідає IdP
   - Спробуйте різні алгоритми підпису (SHA-256, SHA-1, SHA-512)
   - Переконайтеся, що алгоритм дайджесту відповідає конфігурації IdP

2. **Проблеми з сертифікатом**:
   - Переконайтеся, що налаштований правильний сертифікат підпису
   - Перевірте, чи сертифікат відповідає приватному ключу, який використовує IdP
   - Перевірте, чи не відбувалась ротація сертифікатів в IdP

### Проблеми конфігурації

#### Неправильний Entity ID або ACS URL

**Симптоми**:
- IdP повідомляє "Unknown Service Provider"
- SAML-відповіді надсилаються на неправильний endpoint
- Аутентифікація не завершується

**Рішення**:
1. **Перевірте інформацію SP**:
   - Скопіюйте точний Entity ID з конфігурації FastComments
   - Переконайтеся, що ACS URL відповідає формату: `https://fastcomments.com/saml/callback/{tenant-id}`
   - Перевірте помилки введення в tenant ID

2. **Конфігурація IdP**:
   - Оновіть IdP з правильним Entity ID SP
   - Налаштуйте правильний ACS/Reply URL
   - Перевірте налаштування binding в IdP (переважно HTTP-POST)

#### Відсутні або неправильні атрибути

**Симптоми**:
- Користувачі створюються без правильних ролей
- Відсутня інформація профілю користувача
- Помилки "Email required"

**Рішення**:
1. **Атрибут email**:
   - Переконайтеся, що IdP передає атрибут email
   - Перевірте відображення імені атрибуту (email, emailAddress тощо)
   - Переконайтеся, що значення email є дійсною електронною адресою

2. **Атрибути ролей**:
   - Підтвердіть, що IdP передає інформацію про роль/групу
   - Перевірте, чи імена атрибутів ролей відповідають очікуванням FastComments
   - Переконайтеся, що значення ролей точно відповідають іменам ролей FastComments

3. **Формат атрибутів**:
   - Тестуйте як масивний, так і через кому формат ролей
   - Переконайтеся, що значення атрибутів не мають зайвих пробілів
   - Перевірте чутливість до регістру в іменах ролей

### Проблеми потоку аутентифікації

#### Петля перенаправлень

**Симптоми**:
- Браузер безкінечно перенаправляє між FastComments та IdP
- Аутентифікація ніколи не завершується
- У інструментах розробника браузера показано багато перенаправлень

**Рішення**:
1. **Перевірте конфігурацію SP**:
   - Переконайтеся, що Entity ID точно збігається з конфігурацією IdP
   - Переконайтеся, що ACS URL правильно налаштований в IdP
   - Перевірте наявність/відсутність закінчувальних слешів у URL

2. **Проблеми сесії**:
   - Очистіть куки браузера та спробуйте знову
   - Тестуйте у вікні інкогніто/приватного перегляду
   - Перевірте налаштування таймаутів сесії

#### Відмова в доступі після аутентифікації

**Симптоми**:
- Аутентифікація SAML пройшла успішно
- Користувача перенаправлено до FastComments
- Відображається "Access denied" або помилка дозволів

**Рішення**:
1. **Призначення ролей**:
   - Переконайтеся, що у користувача є відповідні ролі в IdP
   - Перевірте, що атрибут ролі надсилається в SAML-відповіді
   - Підтвердіть, що імена ролей точно відповідають вимогам FastComments

2. **Обмеження пакету**:
   - Перевірте, чи акаунт має план Flex або Pro
   - Перевірте, чи функція SAML увімкнена для пакету
   - Зверніться до підтримки, якщо пакет включає SAML, але функція недоступна

### Проблеми, специфічні для провайдерів ідентифікації

#### Microsoft Azure AD

**Поширені проблеми**:
- Призначення ролей додатка не відображається в токенах
- Клами не надсилаються належним чином
- Вимоги щодо призначення користувача

**Рішення**:
- Перевірте призначення користувача для додатку FastComments
- Переконайтеся, що ролі додатку налаштовані правильно
- Переконайтеся, що відображення клеймів включає необхідні атрибути

#### Okta

**Поширені проблеми**:
- Фільтри груп працюють некоректно
- Неправильно налаштовані твердження атрибутів
- Проблеми з призначенням додатка

**Рішення**:
- Перегляньте конфігурацію attribute statement
- Перевірте призначення груп і правила фільтрації
- Переконайтеся, що додаток призначено відповідним користувачам/групам

#### Google Workspace

**Поширені проблеми**:
- Користувацькі атрибути відображаються неправильно
- Членство в групах не передається
- Помилки в конфігурації SAML-додатка

**Рішення**:
- Налаштуйте користувацьку схему для атрибутів ролей
- Перевірте поширення членства в групах
- Переконайтеся в правильності відображення атрибутів SAML-додатка

### Мережеві та підключення

#### Помилки таймауту

**Симптоми**:
- Процес аутентифікації втрачає час (time out)
- Повідомлення "Request timeout" або подібні помилки
- Повільний процес аутентифікації

**Рішення**:
1. **Мережеве з’єднання**:
   - Перевірте правила брандмауера, щоб вони дозволяли зв’язок з FastComments
   - Переконайтеся в коректному DNS-розв’язуванні для fastcomments.com
   - Перевірте мережеве з’єднання з IdP до FastComments

2. **Проблеми продуктивності**:
   - Перевірте часи відповіді IdP
   - Переконайтеся, що перевірка ланцюжка сертифікатів не займає багато часу
   - Розгляньте мережеву затримку між IdP і користувачами

#### Проблеми SSL/TLS

**Симптоми**:
- Попередження про сертифікат під час аутентифікації
- Збої SSL-під час рукостискання
- Помилки "Secure connection failed"

**Рішення**:
- Переконайтеся, що всі SAML endpoint-адреси використовують HTTPS
- Перевірте дійсність сертифікатів для всіх залучених доменів
- Перевірте сумісність версій TLS

### Налагодження та логування

#### Увімкнення відлагоджувальної інформації

1. **Інструменти розробника браузера**:
   - Моніторте вкладку Network під час SAML-потоку
   - Перевірте Console на наявність JavaScript-помилок
   - Перегляньте SAML POST-запити (якщо видимі)

2. **Логування IdP**:
   - Увімкніть SAML-налагодження в вашому IdP
   - Перегляньте логи IdP для деталей запитів/відповідей SAML
   - Перевірте проблеми відображення атрибутів

#### Поширені повідомлення в логах

**Логи FastComments**:
- "SAML config not found" - SAML не увімкнено або помилково налаштовано
- "Invalid certificate" - Перевірка сертифіката не пройшла
- "Missing email attribute" - Відсутній обов’язковий email в SAML-відповіді

**Логи IdP**:
- "Unknown service provider" - Невідповідність Entity ID
- "Invalid ACS URL" - Неправильний Assertion Consumer Service URL
- "User not assigned" - Користувач не має доступу до SAML-додатка

### Отримання допомоги

#### Інформація, яку слід зібрати

Під час звернення до підтримки надайте:
- Точні повідомлення про помилки та часові мітки
- Деталі конфігурації SAML (без конфіденційних даних)
- Тип та версію IdP
- Кроки для відтворення проблеми
- Інформацію про браузер та мережу

#### Підтримка FastComments

Для питань, пов’язаних з SAML:
1. Використайте [support portal](https://fastcomments.com/auth/my-account/help)
2. Вкажіть tenant ID та електронні адреси постраждалих користувачів
3. Надайте повідомлення про помилки та деталі конфігурації
4. Вкажіть тип IdP та підхід до конфігурації

#### Підтримка IdP

Для специфічних питань IdP:
- Консультуйтеся з документацією IdP щодо налагодження SAML
- Використовуйте канали підтримки IdP для проблем конфігурації
- Скористайтеся форумами спільноти IdP для поширених питань

### Профілактичні поради

#### Найкращі практики

1. **Ретельно тестуйте**:
   - Тестуйте зміни конфігурації в непроекційному середовищі
   - Перевіряйте з кількома тестовими користувачами
   - Документуйте робочі конфігурації

2. **Моніторьте регулярно**:
   - Налаштуйте моніторинг для збоїв аутентифікації SAML
   - Перевіряйте дати закінчення терміну дії сертифікатів
   - Моніторьте зміни конфігурації IdP

3. **Документація**:
   - Підтримуйте документацію конфігурації SAML
   - Документуйте будь-які нестандартні налаштування або тимчасові рішення
   - Зберігайте контактну інформацію адміністраторів IdP

#### Проактивне обслуговування

1. **Керування сертифікатами**:
   - Слідкуйте за датами закінчення сертифікатів
   - Плануйте процедури ротації сертифікатів
   - Тестуйте оновлення сертифікатів до їх закінчення

2. **Перегляди конфігурації**:
   - Регулярно переглядайте конфігурацію SAML
   - Переконайтеся, що конфігурація IdP залишається актуальною
   - Оновлюйте документацію при внесенні змін