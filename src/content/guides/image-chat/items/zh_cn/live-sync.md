### 实时更新

Image Chat 使用 WebSocket 连接在所有已连接用户之间实时同步所有对话。当有人创建新的标记、添加评论或删除讨论时，所有正在查看同一图像的其他用户会立即看到更新，无需刷新。

### WebSocket 同步如何工作

当您初始化 Image Chat 时，组件会与 FastComments 服务器建立 WebSocket 连接。此连接在用户会话期间保持打开，并侦听与当前图像相关的更新。

WebSocket 系统为 Image Chat 使用三种类型的广播消息。当有人在图像上创建新标记时，会触发 `new-image-chat` 事件。当有人更新现有对话时，会触发 `image-chat-updated` 事件。当有人删除标记时，会触发 `deleted-image-chat` 事件。

### 广播 ID 系统

为防止回声效应（用户看到自己操作被广播回自己），每个更新都包含唯一的 `broadcastId`。当用户创建或更新标记时，客户端会为该操作生成一个 UUID。当 WebSocket 将更新广播回所有客户端时，发起操作的客户端会忽略该更新，因为它与自身的 `broadcastId` 相匹配。

这确保了流畅的交互：用户在界面上立即看到自己的更改，而无需等待通过服务器的往返，同时仍能确保所有其他用户接收到该更新。

### 连接弹性

如果因网络问题或服务器维护导致 WebSocket 连接中断，组件会自动尝试重新连接。在重连期间，用户仍然可以与现有标记交互，但他们在连接重新建立之前不会看到其他用户的实时更新。

一旦重新连接，组件会重新同步以确保没有错过任何更新。此过程是透明的，不需要用户干预。

### 带宽考量

WebSocket 消息轻量且仅包含同步状态所需的必要信息。创建新标记通常使用的带宽小于 1KB。该系统还包括智能批处理，以在高活动期间减少消息频率。

您在 FastComments 仪表板中的使用统计会跟踪 `pubSubMessageCount` 和 `pubSubBandwidth`，以便您监控跨站点的实时同步活动。

### 跨标签页同步

如果用户在多个浏览器标签页中打开同一页面，一个标签页中的更新会立即出现在其他标签页中。这通过相同的 WebSocket 同步机制实现，无需任何额外配置。

用户可以在多台设备上同时打开您的站点，所有设备都会保持同步。如果两台设备都在查看同一图像，在桌面上创建的标记会立即出现在用户的平板上。

### 安全

WebSocket 消息通过安全连接（WSS）传输，并包含租户验证，以确保用户仅接收其有权查看的对话更新。服务器在广播之前会验证所有操作，以防止未授权的访问或篡改。

### 离线行为

当用户完全离线时，他们仍然可以查看现有标记，但无法创建新标记或查看他人的更新。组件会检测离线状态并显示适当的提示信息。

如果用户在离线时尝试创建标记然后重新上线，该操作将失败而不是排队，从而确保数据一致性。用户应在连接恢复后重试该操作。

### 性能影响

WebSocket 连接对性能的影响最小。当没有更新发生时，连接保持空闲，只有在发生活动时才处理消息。在具有中等标记活动的典型图像上，WebSocket 使用的 CPU 通常比渲染图像本身要少。

对于同时有数百名用户且标记创建活动频繁的页面，系统会进行水平扩展以保持性能，而不会影响单个客户端连接。

### 协作使用场景

实时同步使 Image Chat 对协作工作流特别强大。设计团队可以一起审查模型草图，所有人实时看到标记的位置。客户支持团队可以协同注释屏幕截图以识别问题。教学小组可以讨论图表，所有参与者在标记创建时都能看到彼此的标记。

即时反馈相比传统评论系统（用户需要刷新才能看到更新）创造了更具吸引力和更高产的协作体验。

---