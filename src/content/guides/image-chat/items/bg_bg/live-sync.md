### Актуализации в реално време

Image Chat използва WebSocket връзки за синхронизиране на всички разговори в реално време между всички свързани потребители. Когато някой създаде нов маркер, добави коментар или изтрие обсъждане, всички останали потребители, които гледат същото изображение, виждат обновлението незабавно без презареждане.

### Как работи синхронизацията чрез WebSocket

Когато инициализирате Image Chat, widget-ът установява WebSocket връзка със сървърите на FastComments. Тази връзка остава отворена за продължителността на сесията на потребителя и слуша за обновления, свързани с настоящото изображение.

WebSocket системата използва три вида broadcast съобщения за Image Chat. Събитието `new-image-chat` се задейства, когато някой създаде нов маркер върху изображението. Събитието `image-chat-updated` се задейства, когато някой обнови съществуващ разговор. Събитието `deleted-image-chat` се задейства, когато някой изтрие маркер.

### Система за Broadcast ID

За да се предотврати ефект на ехо, при който потребителите виждат своите собствени действия върнати обратно към тях, всяко обновление включва уникален `broadcastId`. Когато потребител създава или обновява маркер, неговият клиент генерира UUID за тази операция. Когато WebSocket излъчи обновлението обратно към всички клиенти, произходният клиент игнорира обновлението, защото то съвпада с неговия собствен `broadcastId`.

Това гарантира плавно взаимодействие, при което потребителите виждат промените си незабавно в интерфейса без да чакат пътуването до сървъра и обратно, като същевременно всички останали потребители получават обновлението.

### Устойчивост на връзката

Ако WebSocket връзката прекъсне поради мрежови проблеми или поддръжка на сървъра, widget-ът автоматично опитва да се свърже отново. По време на периода на повторно свързване потребителите все още могат да взаимодействат със съществуващите маркери, но няма да виждат актуализации в реално време от други потребители, докато връзката не бъде възстановена.

След възстановяване на връзката widget-ът се синхронизира повторно, за да гарантира, че не са пропуснати обновления. Това се случва прозрачно, без да се изисква намеса от страна на потребителя.

### Съображения относно честотната лента

WebSocket съобщенията са леки и съдържат само необходимата информация за синхронизиране на състоянието. Създаването на нов маркер обикновено използва по-малко от 1KB честотна лента. Системата включва и интелигентно пакетиране, за да намали честотата на съобщенията по време на периоди с висока активност.

Метриките за използване в таблото на FastComments проследяват `pubSubMessageCount` и `pubSubBandwidth`, така че да можете да наблюдавате активността на синхронизацията в реално време по вашите сайтове.

### Синхронизация между раздели

Ако потребителят има една и съща страница отворена в няколко раздела на браузъра, обновленията в един раздел се появяват незабавно и в другите раздели. Това работи чрез същия механизъм за WebSocket синхронизация и не изисква допълнителна конфигурация.

Потребителите могат да имат вашия сайт отворен на няколко устройства едновременно и всички те ще останат синхронизирани. Маркер, създаден на настолен компютър, се появява незабавно на таблета на потребителя, ако и двете устройства разглеждат едно и също изображение.

### Сигурност

WebSocket съобщенията се предават по защитени връзки (WSS) и включват проверка на наемателя, за да се гарантира, че потребителите получават само обновления за разговори, които имат право да виждат. Сървърът валидира всички операции преди да ги излъчи, за да предотврати неоторизиран достъп или манипулация.

### Поведение при офлайн режим

Когато потребителите са напълно офлайн, те все още могат да виждат съществуващите маркери, но не могат да създават нови или да виждат обновления от други. Widget-ът открива офлайн състоянието и показва подходящо съобщение.

Ако потребител се опита да създаде маркер докато е офлайн и след това се върне онлайн, операцията ще се провали вместо да бъде поставена в опашка, гарантирайки консистентност на данните. Потребителите трябва да опитат отново операцията, след като връзката им бъде възстановена.

### Влияние върху производителността

WebSocket връзката има минимално въздействие върху производителността. Връзката остава неактивна, когато няма обновления, и обработва съобщения само при възникване на активност. При типично изображение със средна активност на маркерите, WebSocket използва по-малко CPU, отколкото самото изобразяване на изображението.

За страници със стотици едновременно потребители и висока активност по създаване на маркери, системата се мащабира хоризонтално, за да поддържа производителността без да влияе на отделните клиентски връзки.

### Сценарии за съвместна работа

Синхронизацията в реално време прави Image Chat особено мощен за съвместни работни процеси. Дизайн екипи могат да преглеждат макети заедно, като всички виждат позициите на маркерите в реално време. Екипи за поддръжка на клиенти могат съвместно да анотират скрийншотове, за да идентифицират проблеми. Образователни групи могат да обсъждат диаграми, като всички участници виждат маркерите на другите в момента на тяхното създаване.

Незабавната обратна връзка създава по-ангажиращо и продуктивно съвместно изживяване в сравнение с традиционните системи за коментари, където потребителите трябва да презареждат, за да видят обновления.