### リアルタイム更新

Image ChatはWebSocket接続を使用して、接続中のすべてのユーザー間で会話をリアルタイムに同期します。誰かが新しいマーカーを作成したり、コメントを追加したり、ディスカッションを削除したりすると、同じ画像を見ている他のすべてのユーザーはページを更新することなく即座にその更新を確認できます。

### WebSocket同期の仕組み

Image Chatを初期化すると、ウィジェットはFastCommentsサーバーへのWebSocket接続を確立します。この接続はユーザーのセッション期間中開いたままとなり、現在の画像に関連する更新を待ち受けます。

WebSocketシステムはImage Chatのために3種類のブロードキャストメッセージを使用します。`new-image-chat` イベントは誰かが画像上に新しいマーカーを作成したときに発火します。`image-chat-updated` イベントは誰かが既存の会話を更新したときに発火します。`deleted-image-chat` イベントは誰かがマーカーを削除したときに発火します。

### ブロードキャストIDシステム

ユーザーが自分のアクションを自分に戻ってブロードキャストされることで発生するエコー効果を防ぐために、各更新には一意の `broadcastId` が含まれます。ユーザーがマーカーを作成または更新する際、クライアントはその操作に対してUUIDを生成します。WebSocketが更新をすべてのクライアントにブロードキャストするとき、発信元のクライアントは自分の `broadcastId` と一致するためその更新を無視します。

これにより、ユーザーはサーバーを経由した往復を待つことなくUI上で自分の変更を即座に確認でき、同時に他のすべてのユーザーにも更新が確実に行き渡るようになります。

### 接続の回復性

ネットワーク障害やサーバーメンテナンスによりWebSocket接続が切断された場合、ウィジェットは自動的に再接続を試みます。再接続中でも既存のマーカーとのやり取りは可能ですが、接続が再確立されるまでは他のユーザーによるリアルタイム更新は表示されません。

再接続が完了すると、ウィジェットは見逃した更新がないことを確認するために再同期を行います。これはユーザーの介入を必要とせず透過的に行われます。

### 帯域幅に関する考慮事項

WebSocketメッセージは軽量で、状態を同期するために必要な最小限の情報のみを含みます。新しいマーカーの作成は通常1KB未満の帯域幅を使用します。システムには高活動期間中のメッセージ頻度を削減するためのインテリジェントなバッチ処理も含まれています。

FastCommentsダッシュボードの使用状況メトリクスは `pubSubMessageCount` と `pubSubBandwidth` を追跡するため、サイト全体のリアルタイム同期アクティビティを監視できます。

### タブ間同期

ユーザーが同じページを複数のブラウザタブで開いている場合、あるタブでの更新は他のタブにも即座に反映されます。これは同じWebSocket同期メカニズムを通じて動作し、追加の設定は必要ありません。

ユーザーは複数のデバイスでサイトを同時に開くことができ、すべてのデバイスが同期された状態を維持します。デスクトップで作成されたマーカーは、両方のデバイスが同じ画像を表示している場合にタブレット上でも瞬時に表示されます。

### セキュリティ

WebSocketメッセージは安全な接続（WSS）で送信され、テナント検証を含んでいるため、ユーザーは自身が閲覧を許可されている会話の更新のみを受信します。サーバーは不正アクセスや改ざんを防ぐため、ブロードキャストする前にすべての操作を検証します。

### オフライン時の動作

ユーザーが完全にオフラインの場合、既存のマーカーを表示することはできますが、新しいマーカーを作成したり他のユーザーからの更新を見ることはできません。ウィジェットはオフライン状態を検出し、適切なメッセージを表示します。

ユーザーがオフライン時にマーカーを作成し、その後オンラインに戻った場合、その操作はキューに蓄積されるのではなく失敗します。データの一貫性を保つため、ユーザーは接続が復旧したら操作を再試行する必要があります。

### パフォーマンスへの影響

WebSocket接続はパフォーマンスへの影響が最小限です。更新が発生していないときは接続はアイドル状態になり、アクティビティがあるときだけメッセージを処理します。通常のマーカー活動のある画像では、WebSocketのCPU使用量は画像自体のレンダリングよりも少ないです。

数百人の同時ユーザーと高いマーカー作成アクティビティを伴うページでも、システムは個々のクライアント接続に影響を与えることなく水平スケーリングしてパフォーマンスを維持します。

### 共同作業のユースケース

リアルタイム同期により、Image Chatは共同作業ワークフローに特に有用です。デザインチームはモックアップを一緒にレビューし、全員がマーカーの配置をリアルタイムで確認できます。カスタマーサポートチームは問題の特定のためにスクリーンショットに共同で注釈を付けることができます。教育グループは図を参加者全員で議論し、作成されるマーカーを互いに確認しながら進められます。

即時のフィードバックにより、ユーザーが更新を見るためにリフレッシュする必要がある従来のコメントシステムと比べて、より魅力的で生産性の高い共同作業体験が生まれます。