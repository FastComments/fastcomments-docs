### 即時更新

Image Chat 使用 WebSocket 連線來即時同步所有已連線使用者之間的對話。當有人建立新的標記、加入留言或刪除討論時，所有正在檢視相同圖片的其他使用者會立即看到更新而不需重新整理。

### WebSocket 同步如何運作

當您初始化 Image Chat 時，這個小工具會與 FastComments 伺服器建立一個 WebSocket 連線。此連線在使用者的會話期間保持開啟，並監聽與當前圖片相關的更新。

WebSocket 系統為 Image Chat 使用三種類型的廣播訊息。`new-image-chat` 事件在有人於圖片上建立新標記時觸發。`image-chat-updated` 事件在有人更新既有對話時觸發。`deleted-image-chat` 事件在有人刪除標記時觸發。

### 廣播 ID 系統

為防止回音效應（使用者看到自己執行的動作又被廣播回來），每次更新都包含唯一的 `broadcastId`。當使用者建立或更新標記時，他們的用戶端會為該操作產生一個 UUID。當 WebSocket 將更新廣播回所有用戶端時，原始用戶端會忽略該更新，因為它與自己的 `broadcastId` 相符。

這確保了順暢的互動體驗：使用者能立即在 UI 中看到他們的變更，而不必等伺服器往返的回應，同時也確保所有其他使用者會收到該更新。

### 連線復原能力

如果 WebSocket 連線因網路問題或伺服器維護而中斷，該小工具會自動嘗試重新連線。在重新連線期間，使用者仍可與現有標記互動，但在連線重新建立之前，他們不會看到其他使用者的即時更新。

一旦重新連線，小工具會重新同步以確保沒有遺漏的更新。這個過程是透明的，不需要使用者介入。

### 頻寬考量

WebSocket 訊息輕量，只包含同步狀態所需的必要資訊。建立新標記通常使用不到 1KB 的頻寬。系統亦包含智慧批次處理，以在高活動期間減少訊息頻率。

您在 FastComments 儀表板中的使用量指標會追蹤 `pubSubMessageCount` 與 `pubSubBandwidth`，以便您監控跨網站的即時同步活動。

### 跨分頁同步

如果使用者在多個瀏覽器分頁開啟相同頁面，一個分頁的更新會立即出現在其他分頁。這是透過相同的 WebSocket 同步機制運作，且不需要任何額外設定。

使用者也可以在多個裝置同時開啟您的網站，所有裝置都會保持同步。若在桌機上建立標記，且平板也在檢視相同圖片，該標記會立即出現在平板上。

### 安全性

WebSocket 訊息經由安全連線（WSS）傳輸，並包含租戶驗證以確保使用者僅收到其有權檢視的對話更新。伺服器在廣播前會驗證所有操作，以防止未授權的存取或操控。

### 離線行為

當使用者完全離線時，他們仍可檢視既有標記，但無法建立新標記或看到其他人的更新。小工具會偵測離線狀態並顯示適當的訊息。

如果使用者在離線時嘗試建立標記，之後回到線上時該操作會失敗而非排隊，這可確保資料一致性。使用者應在連線恢復後重試該操作。

### 效能影響

WebSocket 連線對效能的影響極小。當沒有更新發生時，連線處於閒置狀態，僅在有活動時處理訊息。在標記活動適中的一般圖片上，WebSocket 使用的 CPU 通常少於渲染圖片本身所需的 CPU。

對於有數百名同時使用者且標記建立活動頻繁的頁面，系統會橫向擴展以維持效能，同時不影響單一用戶端的連線。

### 協作使用情境

即時同步使 Image Chat 對協作工作流程特別有用。設計團隊可以一起檢閱模型，所有人會即時看到標記位置。客戶支援團隊可以共同註解截圖以找出問題。教學群組可以討論圖表，所有參與者在標記建立時即時看到彼此的標記。

即時回饋相較於需要重新整理才能看到更新的傳統留言系統，能提供更具互動性與生產力的協作體驗。