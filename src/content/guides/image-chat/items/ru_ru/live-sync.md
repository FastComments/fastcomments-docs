### Real-Time Updates

Image Chat использует WebSocket-подключения для синхронизации всех разговоров в реальном времени между всеми подключенными пользователями. Когда кто-то создаёт новый маркер, добавляет комментарий или удаляет обсуждение, все остальные пользователи, просматривающие ту же картинку, сразу видят обновление без перезагрузки.

### How WebSocket Sync Works

Когда вы инициализируете Image Chat, виджет устанавливает WebSocket-подключение к серверам FastComments. Это подключение остаётся открытым на протяжении сеанса пользователя и слушает обновления, связанные с текущим изображением.

Система WebSocket использует три типа широковещательных сообщений для Image Chat. Событие `new-image-chat` срабатывает, когда кто-то создаёт новый маркер на изображении. Событие `image-chat-updated` срабатывает, когда кто-то обновляет существующий разговор. Событие `deleted-image-chat` срабатывает, когда кто-то удаляет маркер.

### Broadcast ID System

Чтобы избежать эффекта эха, когда пользователи видят собственные действия, отсылаемые обратно им, каждое обновление включает уникальный `broadcastId`. Когда пользователь создаёт или обновляет маркер, его клиент генерирует UUID для этой операции. Когда WebSocket рассылает обновление всем клиентам, исходный клиент игнорирует это обновление, потому что оно совпадает с его собственным `broadcastId`.

Это обеспечивает плавное взаимодействие: пользователи видят свои изменения сразу в интерфейсе без ожидания полного круга через сервер, при этом все остальные пользователи также получают обновление.

### Connection Resilience

Если WebSocket-подключение обрывается из-за проблем с сетью или техобслуживания сервера, виджет автоматически пытается переподключиться. В период переподключения пользователи всё ещё могут взаимодействовать с существующими маркерами, но они не будут видеть обновления от других пользователей до восстановления соединения.

После восстановления соединения виджет повторно синхронизируется, чтобы убедиться, что никакие обновления не были пропущены. Это происходит прозрачно и не требует вмешательства пользователя.

### Bandwidth Considerations

Сообщения WebSocket лёгкие и содержат только необходимую информацию для синхронизации состояния. Создание нового маркера обычно использует менее 1KB трафика. Система также включает интеллектуальную пакетную обработку, чтобы уменьшить частоту сообщений в периоды высокой активности.

Ваши показатели использования на панели управления FastComments отслеживают `pubSubMessageCount` и `pubSubBandwidth`, чтобы вы могли мониторить активность синхронизации в реальном времени на своих сайтах.

### Cross-Tab Synchronization

Если пользователь открыл одну и ту же страницу в нескольких вкладках браузера, обновления в одной вкладке появляются сразу в других вкладках. Это работает через ту же систему синхронизации WebSocket и не требует дополнительной настройки.

Пользователи могут иметь ваш сайт открытым на нескольких устройствах одновременно, и все они будут оставаться синхронизированными. Маркер, созданный на настольном компьютере, появляется мгновенно на планшете пользователя, если оба устройства просматривают одно и то же изображение.

### Security

Сообщения WebSocket передаются по защищённым соединениям (WSS) и включают проверку арендатора, чтобы гарантировать, что пользователи получают только те обновления, к которым они имеют доступ. Сервер проверяет все операции перед их трансляцией, чтобы предотвратить неавторизованный доступ или манипуляции.

### Offline Behavior

Когда пользователи полностью офлайн, они всё ещё могут просматривать существующие маркеры, но не могут создавать новые и не видят обновлений от других. Виджет обнаруживает состояние офлайн и отображает соответствующие сообщения.

Если пользователь пытается создать маркер будучи офлайн, а затем снова выходит в сеть, операция завершится неудачей, а не будет поставлена в очередь, чтобы обеспечить согласованность данных. Пользователям следует повторить операцию после восстановления соединения.

### Performance Impact

WebSocket-подключение минимально влияет на производительность. Подключение остаётся в простое, когда обновлений не происходит, и обрабатывает сообщения только при активности. На типичном изображении с умеренной активностью маркеров WebSocket использует меньше CPU, чем рендеринг самого изображения.

Для страниц с сотнями одновременных пользователей и высокой активностью по созданию маркеров система масштабируется горизонтально, чтобы поддерживать производительность без влияния на отдельные клиентские подключения.

### Collaborative Use Cases

Синхронизация в реальном времени делает Image Chat особенно мощным для совместной работы. Команды дизайнеров могут одновременно просматривать макеты, при этом все видят размещение маркеров в реальном времени. Команды поддержки клиентов могут совместно аннотировать скриншоты для выявления проблем. Учебные группы могут обсуждать диаграммы, при этом все участники видят маркеры друг друга по мере их создания.

Немедленная обратная связь создаёт более увлекательный и продуктивный опыт совместной работы по сравнению с традиционными системами комментариев, где пользователям нужно обновлять страницу, чтобы увидеть изменения.