### Real-Time Updates

Image Chat использует WebSocket-соединения для синхронизации всех бесед в режиме реального времени между всеми подключенными пользователями. Когда кто-то создаёт новый маркер, добавляет комментарий или удаляет обсуждение, все остальные пользователи, просматривающие то же изображение, видят обновление мгновенно без перезагрузки.

### How WebSocket Sync Works

Когда вы инициализируете Image Chat, виджет устанавливает WebSocket-соединение с серверами FastComments. Это соединение остаётся открытым на протяжении сессии пользователя и прослушивает обновления, связанные с текущим изображением.

Система WebSocket использует три типа широковещательных сообщений для Image Chat. Событие `new-image-chat` срабатывает, когда кто-то создаёт новый маркер на изображении. Событие `image-chat-updated` срабатывает, когда кто-то обновляет существующее обсуждение. Событие `deleted-image-chat` срабатывает, когда кто-то удаляет маркер.

### Broadcast ID System

Чтобы предотвратить эффект эха, когда пользователи видят свои собственные действия, транслируемые обратно, каждое обновление включает уникальный `broadcastId`. Когда пользователь создаёт или обновляет маркер, его клиент генерирует UUID для этой операции. Когда WebSocket транслирует обновление обратно всем клиентам, исходный клиент игнорирует обновление, потому что оно совпадает с его собственным `broadcastId`.

Это обеспечивает плавное взаимодействие: пользователи видят свои изменения сразу в UI без ожидания кругового обмена через сервер, при этом все остальные пользователи получают обновление.

### Connection Resilience

Если WebSocket-соединение прерывается из-за сетевых проблем или обслуживания сервера, виджет автоматически пытается переподключиться. В период переподключения пользователи по-прежнему могут взаимодействовать с существующими маркерами, но они не будут видеть обновления от других пользователей, пока соединение не будет восстановлено.

После восстановления соединения виджет повторно синхронизируется, чтобы убедиться, что не было пропущено обновлений. Это происходит прозрачно и не требует вмешательства пользователя.

### Bandwidth Considerations

Сообщения WebSocket лёгкие и содержат только необходимую информацию для синхронизации состояния. Создание нового маркера обычно использует менее 1KB трафика. Система также включает интеллектуальную группировку сообщений, чтобы снизить частоту сообщений в периоды высокой активности.

Ваша статистика использования в панели FastComments отслеживает `pubSubMessageCount` и `pubSubBandwidth`, чтобы вы могли контролировать активность синхронизации в реальном времени на ваших сайтах.

### Cross-Tab Synchronization

Если пользователь открыл одну и ту же страницу в нескольких вкладках браузера, обновления в одной вкладке появляются сразу в других вкладках. Это работает через тот же механизм синхронизации WebSocket и не требует дополнительной конфигурации.

Пользователи могут иметь ваш сайт открытым на нескольких устройствах одновременно, и все они останутся синхронизированными. Маркер, созданный на настольном компьютере, мгновенно появляется на планшете пользователя, если оба устройства просматривают одно и то же изображение.

### Security

Сообщения WebSocket передаются по защищённым соединениям (WSS) и включают проверку tenant, чтобы пользователи получали только те обновления, к которым они уполномочены иметь доступ. Сервер проверяет все операции перед их широковещательной отправкой, чтобы предотвратить несанкционированный доступ или манипуляции.

### Offline Behavior

Когда пользователи полностью офлайн, они всё ещё могут просматривать существующие маркеры, но не могут создавать новые или видеть обновления от других. Виджет обнаруживает офлайн-состояние и отображает соответствующие сообщения.

Если пользователь пытается создать маркер в офлайне, а затем выходит в онлайн, операция завершится неудачей, а не будет поставлена в очередь, чтобы обеспечить согласованность данных. Пользователям следует повторить операцию, когда соединение будет восстановлено.

### Performance Impact

WebSocket-соединение оказывает минимальное влияние на производительность. Соединение остаётся простаивающим, когда обновлений не происходит, и обрабатывает сообщения только при активности. На типичном изображении с умеренной активностью маркеров WebSocket использует меньше CPU, чем отрисовка самого изображения.

Для страниц со сотнями одновременных пользователей и высокой активностью по созданию маркеров система масштабируется горизонтально, чтобы поддерживать производительность, не влияя на отдельные клиентские соединения.

### Collaborative Use Cases

Синхронизация в реальном времени делает Image Chat особенно полезным для совместных рабочих процессов. Команды дизайнеров могут вместе просматривать макеты, при этом все видят размещение маркеров в реальном времени. Команды поддержки клиентов могут совместно аннотировать скриншоты для выявления проблем. Образовательные группы могут обсуждать диаграммы, и все участники видят маркеры друг друга по мере их создания.

Немедленная обратная связь создаёт более вовлечённый и продуктивный совместный опыт по сравнению с традиционными системами комментариев, где пользователям приходится обновлять страницу, чтобы увидеть изменения.