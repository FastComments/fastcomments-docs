### リアルタイム更新

Collab Chat は WebSocket 接続を使用して、接続されているすべてのユーザー間で会話をリアルタイムに同期します。誰かが新しい注釈を作成したり、コメントを追加したり、ディスカッションを削除したりすると、同じページを表示している他のユーザーはページを再読み込みすることなく即座にその更新を確認できます。

### WebSocket 同期の仕組み

Collab Chat を初期化すると、ウィジェットは FastComments サーバーへの WebSocket 接続を確立します。この接続はユーザーのセッションの間開いたままになり、現在のページに関連する更新を監視します。

WebSocket システムは Collab Chat 用に3種類のブロードキャストメッセージを使用します。`new-text-chat` イベントは誰かがページ上に新しい注釈を作成したときに発生します。`updated-text-chat` イベントは誰かが既存の会話を更新したときに発生します。`deleted-text-chat` イベントは誰かが注釈を削除したときに発生します。

### ブロードキャストIDシステム

ユーザーが自分の操作が自身にブロードキャストされて戻ってくることで発生するエコー効果を防ぐため、各更新には一意の `broadcastId` が含まれます。ユーザーが注釈を作成または更新する際、クライアントはその操作のための UUID を生成します。WebSocket が更新をすべてのクライアントにブロードキャストするとき、発信元のクライアントは自分自身の `broadcastId` と一致するためその更新を無視します。

これにより、ユーザーはサーバーを経由する往復を待つことなく UI 上で自分の変更を即座に確認でき、同時に他のすべてのユーザーにも更新が届くことが保証されます。

### ライブユーザー数

トップバーには現在そのページを閲覧しているユーザー数が表示されます。このカウントはユーザーの参加や離脱に応じてリアルタイムに更新されます。ユーザー数は同じ WebSocket 接続を通じて提供され、接続および切断イベントに基づいて自動的に増減します。

### 接続の回復性

ネットワークの問題やサーバーメンテナンスにより WebSocket 接続が切断された場合、ウィジェットは自動的に再接続を試みます。再接続の期間中でもユーザーは既存の注釈とやり取りできますが、接続が再確立されるまでは他のユーザーからのリアルタイム更新は表示されません。

再接続が完了すると、ウィジェットは見逃した更新がないか再同期します。これはユーザーの介入を必要とせず透過的に行われます。

### 帯域幅に関する考慮

WebSocket メッセージは軽量で、状態を同期するために必要な最小限の情報のみを含みます。新しい注釈の作成は通常 1KB 未満の帯域幅を使用します。システムには高いアクティビティ期間中にメッセージ頻度を減らすためのインテリジェントなバッチ処理も含まれています。

FastComments ダッシュボードの使用状況メトリクスは `pubSubMessageCount` と `pubSubBandwidth` を追跡しており、サイト全体のリアルタイム同期アクティビティを監視できます。

### タブ間同期

ユーザーが同じページを複数のブラウザタブで開いている場合、あるタブでの更新は他のタブにも即座に反映されます。これは同じ WebSocket 同期メカニズムを通じて動作し、追加の設定は不要です。

### セキュリティ

WebSocket メッセージはセキュアな接続（WSS）で送信され、テナント検証が含まれているため、ユーザーが許可されている会話の更新のみを受け取ることが保証されます。サーバーはすべての操作をブロードキャストする前に検証し、不正なアクセスや改ざんを防ぎます。