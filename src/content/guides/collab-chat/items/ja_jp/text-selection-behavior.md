---
### テキスト選択の仕組み

ユーザーが Collab Chat コンテナ内でテキストを選択すると、ウィジェットはその選択を取得し、ディスカッションを開始できるようにします。選択は単語1つほどの小さなものから、複数の要素にまたがる段落全体のような大きなものまで可能です。

### 選択遅延

デスクトップでは、ユーザーがテキストを選択してからディスカッションのプロンプトが表示されるまでに3.5秒の遅延があります。これは、ユーザーがテキストをコピーしたり読むためにハイライトするだけの場合に UI がチラつくのを防ぎます。モバイルでは、タッチスクリーンでのテキスト選択がより意図的であるため、プロンプトはすぐに表示されます。


### 一意の会話ID

各会話にはページのURL、DOM要素のパス、シリアライズされたテキスト範囲を組み合わせた一意の `urlId` が割り当てられます。これにより、各テキスト選択が後で再び見つけられる別個の会話を作成します。

設定でカスタムの `urlId` を指定した場合、それは要素パスとテキスト範囲と組み合わされて最終的な識別子が作成されます。

### 視覚的ハイライト

特定のテキスト選択に対してディスカッションが存在する場合、そのテキストは視覚的にハイライトされます。ハイライトは背景色を使って実装され、ホバー時または関連するチャットウィンドウが開いているときに表示されます。

ハイライトの仕組みは、選択したテキストをスタイル可能な特別な要素でラップすることで機能します。この方法により、基盤となるHTML構造が複雑な場合でもハイライトが正確に保持されます。

### チャットウィンドウの位置決め

ユーザーがハイライトをクリックするか新しい注釈を作成すると、選択したテキストの近くにチャットウィンドウが表示されます。ウィジェットは利用可能なビューポートの空間に基づいて、このウィンドウの最適な位置を自動的に計算します。

位置決めシステムは、チャットウィンドウがハイライトからどの方向に伸びるべきかを示すために `to-right`、`to-left`、`to-top`、`to-bottom` のような CSS クラスを使用します。モバイルデバイス（幅768px未満の画面では）では、ユーザビリティ向上のためチャットウィンドウは常に全画面表示になります。

### チャットウィンドウの寸法

チャットウィンドウはデスクトップで幅410px、間隔20px、ハイライトしたテキストを指す16pxの視覚的な矢印があります。これらの寸法は一貫した動作を確保するために固定されていますが、CSSで外観をカスタマイズできます。

### 複数要素にまたがる選択

ユーザーは、ある段落の途中から別の段落の先頭までのように、複数のHTML要素にまたがるテキストを選択できます。範囲のシリアライズシステムはこれを正しく処理し、要素の境界を超えて選択されたすべてのテキストをハイライトします。

### ブラウザ互換性

テキスト選択システムは標準の `window.getSelection()` API を使用しており、すべてのモダンブラウザでサポートされています。古いバージョンの Internet Explorer では互換性のために `document.selection` にフォールバックします。

### 選択の永続性

テキスト選択に対して会話が作成されると、その注釈はページをリロードしても持続します。シリアライズされた範囲とDOMパスにより、ユーザーがページに戻ったときにウィジェットはハイライトを同じ位置に復元できます。

これはページのコンテンツが安定している限り信頼して動作します。テキスト内容を変更したりHTMLを再構成した場合、既存の注釈がテキストと正しく一致しなくなる可能性があります。そのため、アクティブな注釈があるページでは大幅なコンテンツ変更を避けるか、必要な場合は注釈を移行することを検討してください。

---