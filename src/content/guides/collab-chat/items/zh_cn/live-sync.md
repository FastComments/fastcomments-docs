### 实时更新

Collab Chat 使用 WebSocket 连接在所有已连接用户之间实时同步所有会话。当有人创建新的注释、添加评论或删除讨论时，其他在相同页面的用户会立即看到更新，无需刷新。

### WebSocket 同步如何工作

当你初始化 Collab Chat 时，组件会向 FastComments 服务器建立一个 WebSocket 连接。该连接在用户会话期间保持打开，并监听与当前页面相关的更新。

WebSocket 系统为 Collab Chat 使用三种类型的广播消息。`new-text-chat` 事件在有人在页面上创建新注释时触发。`updated-text-chat` 事件在有人更新现有会话时触发。`deleted-text-chat` 事件在有人删除注释时触发。

### 广播 ID 系统

为了防止回显效果（用户看到自己的操作被再次广播回去），每个更新都包含一个唯一的 `broadcastId`。当用户创建或更新注释时，客户端会为该操作生成一个 UUID。当 WebSocket 将更新广播回所有客户端时，发起操作的客户端会忽略该更新，因为它与自己的 `broadcastId` 匹配。

这确保了流畅的交互：用户无需等待通过服务器的往返即可立即在界面上看到自己的更改，同时仍然确保其他所有用户都能收到该更新。

### 实时用户计数

顶栏显示当前正在查看该页面的用户数量。随着用户加入或离开，此计数会实时更新。用户计数通过相同的 WebSocket 连接提供，并会根据连接和断开事件自动增减。

### 连接弹性

如果由于网络问题或服务器维护导致 WebSocket 连接中断，组件会自动尝试重新连接。在重新连接期间，用户仍然可以与现有注释进行交互，但在连接重新建立之前，他们无法看到其他用户的实时更新。

重新连接后，组件会重新同步以确保没有错过任何更新。这一过程是透明的，不需要用户干预。

### 带宽考虑

WebSocket 消息很轻量，只包含同步状态所需的基本信息。创建新注释通常使用不到 1KB 的带宽。系统还包括智能批处理，以在高活动时期减少消息频率。

你在 FastComments 仪表板上的使用指标会跟踪 `pubSubMessageCount` 和 `pubSubBandwidth`，以便你监控跨站点的实时同步活动。

### 跨标签页同步

如果用户在多个浏览器标签页中打开相同页面，一个标签页的更新会立即出现在其他标签页。这通过相同的 WebSocket 同步机制工作，不需要任何额外配置。

### 安全性

WebSocket 消息通过安全连接（WSS）传输，并包含租户验证，以确保用户仅接收他们有权限查看的会话更新。服务器在广播操作之前会验证所有操作，以防止未授权的访问或篡改。