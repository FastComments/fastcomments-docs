### Обновления в реальном времени

Collab Chat использует WebSocket-соединения для синхронизации всех обсуждений в реальном времени между всеми подключенными пользователями. Когда кто-то создаёт новую аннотацию, добавляет комментарий или удаляет обсуждение, все остальные пользователи, просматривающие ту же страницу, сразу видят обновление без перезагрузки.

### Как работает синхронизация через WebSocket

При инициализации Collab Chat виджет устанавливает WebSocket-соединение с серверами FastComments. Это соединение остаётся открытым на всё время сессии пользователя и прослушивает обновления, связанные с текущей страницей.

Система WebSocket использует три типа широковещательных сообщений для Collab Chat. Событие `new-text-chat` срабатывает, когда кто-то создаёт новую аннотацию на странице. Событие `updated-text-chat` срабатывает, когда кто-то обновляет существующий разговор. Событие `deleted-text-chat` срабатывает, когда кто-то удаляет аннотацию.

### Система Broadcast ID

Чтобы предотвратить эффект эха, когда пользователи видят собственные действия, вещаемые обратно им, каждое обновление включает уникальный `broadcastId`. Когда пользователь создаёт или обновляет аннотацию, его клиент генерирует UUID для этой операции. Когда WebSocket вещает обновление обратно всем клиентам, клиент-источник игнорирует это обновление, потому что оно совпадает с его собственным `broadcastId`.

Это обеспечивает плавное взаимодействие: пользователи видят свои изменения сразу в интерфейсе без ожидания кругового обмена через сервер, при этом все остальные пользователи получают обновление.

### Количество пользователей в реальном времени

В верхней панели отображается количество пользователей, которые в данный момент просматривают страницу. Этот счётчик обновляется в реальном времени по мере того, как пользователи подключаются и отключаются. Информация о количестве пользователей поступает через то же самое WebSocket-соединение и автоматически увеличивается/уменьшается на основе событий подключения и отключения.

### Устойчивость соединения

Если WebSocket-соединение прерывается из‑за сетевых проблем или обслуживания сервера, виджет автоматически пытается переподключиться. В период переподключения пользователи по-прежнему могут взаимодействовать с существующими аннотациями, но они не будут видеть обновления в реальном времени от других пользователей до восстановления соединения.

После восстановления соединения виджет повторно синхронизируется, чтобы убедиться, что никакие обновления не были пропущены. Это происходит прозрачно, без необходимости вмешательства пользователя.

### Требования к пропускной способности

Сообщения WebSocket лёгкие и содержат только необходимую информацию для синхронизации состояния. Создание новой аннотации обычно использует меньше 1 КБ трафика. Система также включает интеллектуальную пакетную отправку, чтобы уменьшить частоту сообщений в периоды высокой активности.

Ваши показатели использования в панели FastComments отслеживают `pubSubMessageCount` и `pubSubBandwidth`, чтобы вы могли контролировать активность синхронизации в реальном времени на ваших сайтах.

### Синхронизация между вкладками

Если пользователь открыл одну и ту же страницу в нескольких вкладках браузера, обновления в одной вкладке сразу появляются в других вкладках. Это работает через тот же механизм синхронизации WebSocket и не требует дополнительной настройки.

### Безопасность

Сообщения WebSocket передаются по защищённым соединениям (WSS) и включают проверку tenant-а, чтобы гарантировать, что пользователи получают только те обновления для разговоров, к которым у них есть доступ. Сервер проверяет все операции перед их вещанием, чтобы предотвратить несанкционированный доступ или манипуляции.