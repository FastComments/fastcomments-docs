---
### How Text Selection Works

Когда пользователи выделяют текст внутри контейнера Collab Chat, виджет фиксирует это выделение и позволяет им начать обсуждение. Выделение может быть таким маленьким, как одно слово, или охватывать несколько абзацев, расположенных в разных элементах.

### Selection Delay

На настольных устройствах есть задержка 3.5 секунды между моментом выделения текста пользователем и появлением подсказки для обсуждения. Это предотвращает мерцание интерфейса, когда пользователи просто выделяют текст, чтобы скопировать или прочитать его. На мобильных устройствах подсказка появляется сразу, поскольку выделение текста на сенсорных экранах происходит более целенаправленно.

### Unique Conversation IDs

Каждому разговору присваивается уникальный `urlId`, который комбинирует URL страницы, путь к элементу DOM и сериализованный диапазон текста. Это гарантирует, что каждое выделение текста создает отдельный разговор, который можно будет найти позже.

Если вы укажете собственный `urlId` в вашей конфигурации, он будет комбинироваться с путем элемента и диапазоном текста для формирования итогового идентификатора.

### Visual Highlights

Когда для определенного выделения текста существует обсуждение, этот текст получает визуальную подсветку. Подсветка реализуется с использованием фоновых цветов и появляется при наведении курсора или когда открыто соответствующее окно чата.

Система подсветки работает путем оборачивания выделенного текста в специальный элемент, который можно стилизовать. Такой подход обеспечивает точность подсветок даже при сложной структуре HTML.

### Chat Window Positioning

Когда пользователь кликает по подсветке или создает новую аннотацию, рядом с выделенным текстом появляется окно чата. Виджет автоматически рассчитывает наилучшее положение для этого окна с учетом доступного пространства в области просмотра.

Система позиционирования использует CSS-классы, такие как `to-right`, `to-left`, `to-top` и `to-bottom`, чтобы указать, в каком направлении окно чата должно расширяться от подсветки. На мобильных устройствах (экраны шириной меньше 768px) окно чата всегда отображается во весь экран для лучшей удобности.

### Chat Window Dimensions

Окна чата имеют ширину 410px на настольных устройствах с отступом 20px и 16px визуальной стрелкой, указывающей на выделенный текст. Эти размеры фиксированы для обеспечения предсказуемого поведения, но вы можете настроить внешний вид с помощью CSS.

### Cross-Element Selections

Пользователи могут выделять текст, который пересекает несколько HTML-элементов, например, выделять от середины одного абзаца до начала другого. Система сериализации диапазонов корректно обрабатывает такие случаи и подсвечивает весь выделенный текст, даже через границы элементов.

### Browser Compatibility

Система выделения текста использует стандартный API `window.getSelection()`, который поддерживается во всех современных браузерах. Для старых версий Internet Explorer предусмотрен откат к `document.selection` для совместимости.

### Selection Persistence

После создания разговора для выделения текста эта аннотация сохраняется, даже если страница перезагружается. Сериализованный диапазон и путь в DOM позволяют виджету восстановить подсветки в том же самом месте, когда пользователи возвращаются на страницу.

Это надежно работает, пока содержимое вашей страницы остается стабильным. Если вы измените текстовое содержимое или переструктурируете HTML, существующие аннотации могут больше не совпадать с текстом. По этой причине лучше избегать значительных изменений контента на страницах с активными аннотациями или рассмотреть вариант миграции аннотаций при необходимости изменений контента.

---